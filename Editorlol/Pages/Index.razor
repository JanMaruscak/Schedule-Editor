@page "/"
@using BlazeCardsCore.Components
@using BlazeCardsCore.State
@using BlazeCardsCore.Descriptors

<button @onclick="GoLeft">Left</button>
<button @onclick="GoRight">right</button>
<button @onclick="AddCard">Add card</button>
@(Week+1)/
@(Weeks.Count)

<div style="display: flex;">
    @foreach (var item in Days)
    {
        <div style="display: flex; flex-direction: column">
            <p style="width: 200px; text-align:center">@item.DayOfWeek</p>
            <p style="width: 200px; text-align:center">@item.Day.ToString(). @item.Month.ToString().</p>
        </div>
    }
</div>

<div style="width: 100vw; height: 100vh">
    <CanvasComponent State="@cardState"></CanvasComponent>
</div>

@code {
    private CardState cardState;
    List<DateTime> Days = new List<DateTime>();
    private void AddCard()
    {
        this.cardState.Storage.Cards.Add(new SchoolCard("pepis", "penc", "lol"));
    }
    private void GoRight()
    {
        if (Week + 1 == Weeks.Count)
        {
            var newWeek = new List<VerticalListCard>
    ();
            for (int i = 0; i < 5; i++)
            {
                newWeek.Add(GetTemplateList(i, Width, MarginTop));
            }
            Weeks.Add(newWeek);

            foreach (var item in Weeks[Week])
            {
                this.cardState.Storage.Cards.Remove(item);
                //item.Parent.UnhookChild(item);
            }

            foreach (var item in newWeek)
            {
                this.cardState.Storage.Cards.Add(item);
            }
            GoneRight++;
        }
        else
        {
            foreach (var item in Weeks[Week])
            {
                this.cardState.Storage.Cards.Remove(item);
                //item.Parent.UnhookChild(item);
            }

            foreach (var item in Weeks[Week + 1])
            {
                this.cardState.Storage.Cards.Add(item);
            }
        }
        for (int i = 0; i < Days.Count; i++)
        {
            Days[i] = Days[i].AddDays(7);
        }
        Week++;
        this.cardState.Canvas.InvokeChange();
    }
    private void GoLeft()
    {
        if (Week == 0)
        {
            var newWeek = new List<VerticalListCard>
                ();
            for (int i = 0; i < 5; i++)
            {
                newWeek.Add(GetTemplateList(i, Width, MarginTop));
            }

            foreach (var item in Weeks[Week])
            {
                this.cardState.Storage.Cards.Remove(item);
                //item.Parent.UnhookChild(item);
            }

            foreach (var item in newWeek)
            {
                this.cardState.Storage.Cards.Add(item);
            }
            Weeks.Insert(0, newWeek);
            GoneLeft--;
        }
        else
        {
            foreach (var item in Weeks[Week])
            {
                this.cardState.Storage.Cards.Remove(item);
                //item.Parent.UnhookChild(item);
            }

            foreach (var item in Weeks[Week - 1])
            {
                this.cardState.Storage.Cards.Add(item);
            }
            Week--;
        }
        for (int i = 0; i < Days.Count; i++)
        {
            Days[i] = Days[i].AddDays(-7);
        }
        this.cardState.Canvas.InvokeChange();
    }

    int Week = 0;
    int GoneLeft = 0;
    int GoneRight = 0;

    int MarginTop = 0;
    int Height = 1000;
    int Width = 200;
    int TextMarginBottom = 25;
    int RandomNum = 0;

    List<List<VerticalListCard>> Weeks = new List<List<VerticalListCard>>();

    protected override void OnInitialized()
    {
        this.cardState = new CardState();
        Weeks.Add(new List<VerticalListCard>());
        for (int i = 0; i < 5; i++)
        {
            Days.Add(DateTime.Now.AddDays(i));
        }

        //var monday = new TextCard();
        //monday.TextBehavior.Value = "Monday";
        //monday.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(0 + (Width - (monday.TextBehavior.Value.Length * 20)) / 2, MarginTop - TextMarginBottom);
        //this.cardState.Storage.Cards.Add(monday);

        //var tuesday = new TextCard();
        //tuesday.TextBehavior.Value = "Tuesday";
        //tuesday.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(Width + RandomNum, marginTop - textMarginBottom);
        //this.cardState.Storage.Cards.Add(tuesday);

        //var wednesday = new TextCard();
        //wednesday.TextBehavior.Value = "Wednesday";
        //wednesday.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(width * 2 + randomNum, marginTop - textMarginBottom);
        //this.cardState.Storage.Cards.Add(wednesday);

        //var thursday = new TextCard();
        //thursday.TextBehavior.Value = "Thursday";
        //thursday.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(width * 3 + randomNum, marginTop - textMarginBottom);
        //this.cardState.Storage.Cards.Add(thursday);

        //var friday = new TextCard();
        //friday.TextBehavior.Value = "Friday";
        //friday.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(width * 4 + randomNum, marginTop - textMarginBottom);
        //this.cardState.Storage.Cards.Add(friday);

        for (int i = 0; i < 5; i++)
        {
            var schoolCard = new SchoolCard("VYT", "Penc", "14:30-15:45");
            schoolCard.Time.TextBehavior.Value = "VYT";

            var area = new DropAreaCard();
            area.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(i * Width, MarginTop);
            area.SizeBehavior.Size = new BlazeCardsCore.Models.Vector2f(Width, Height);
            area.Clickable = false;
            area.Draggable = false;
            area.Visible = false;
            area.Classes.Add("school-background");
            var list = new VerticalListCard();
            list.Clickable = false;
            list.Draggable = false;

            area.OnDrop += (o, e) =>
            {
                foreach (var item in e.Cards)
                {
                    if (item.Parent == null)
                    {
                        this.cardState.Storage.Cards.Remove(item);
                        list.AddChild(item);
                    }
                    else if (list != item.Parent)
                    {
                        item.Parent.UnhookChild(item);
                        list.AddChild(item);
                    }
                //if (item is TextCard)
                //{
                //    var downText = item as TextCard;
                //    downText.TextBehavior.Value = downText.PositionBehavior.Position.Y.ToString();
                //}
            }
            };

            list.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(i * Width, MarginTop);

            list.AddChild(schoolCard);

            Weeks[0].Add(list);
            this.cardState.Storage.Cards.Add(area);
            this.cardState.Storage.Cards.Add(list);
        }

        //this.cardState.Storage.Cards.Add(new SchoolCard());
    }
    private VerticalListCard GetTemplateList(int index, int width, int marginTop)
    {
        VerticalListCard newList = new VerticalListCard();
        newList.Clickable = false;
        newList.Draggable = false;
        newList.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(index * width, marginTop);
        return newList;
    }
    //protected override void OnInitialized()
    //{
    //    this.cardState = new CardState();

    //    var text = new TextCard();
    //    var text2 = new TextCard();

    //    text.Classes.Add("school-card");

    //    var area1 = new DropAreaCard();
    //    var area2 = new DropAreaCard();
    //    var area3 = new DropAreaCard();
    //    var area4 = new DropAreaCard();
    //    var area5 = new DropAreaCard();

    //    var list1 = new VerticalListCard();
    //    list1.Classes.Add("day-list");
    //    list1.AddChild(text);
    //    list1.AddChild(area1);

    //    var list2 = new VerticalListCard();
    //    list2.PositionBehavior.Position = new BlazeCardsCore.Models.Vector2f(500f, 500f);
    //    list2.AddChild(text2);
    //    list2.AddChild(area2);

    //    var list3 = new VerticalListCard();
    //    var list4 = new VerticalListCard();
    //    var list5 = new VerticalListCard();

    //    area1.OnDrop += (o, e) =>
    //    {
    //        foreach (var item in e.Cards)
    //        {
    //            item.Parent.UnhookChild(item);
    //            list1.AddChild(item);
    //        }
    //    };
    //    area2.OnDrop += (o, e) =>
    //    {
    //        foreach (var item in e.Cards)
    //        {
    //            item.Parent.UnhookChild(item);
    //            list2.AddChild(item);
    //        }
    //    };
    //    this.cardState.Storage.Cards.Add(list1);
    //    this.cardState.Storage.Cards.Add(list2);
    //    //this.cardState.Storage.Cards.Add(list2);
    //    //this.cardState.Storage.Cards.Add(list3);

    //}
    //protected override void OnInitialized()
    //{
    //    this.cardState = new CardState();

    //    var area = new BlazeCardsCore.Descriptors.DropAreaCard();
    //    var rect = new BlazeCardsCore.Descriptors.RectCard();

    //    var list = new BlazeCardsCore.Descriptors.HorizontalListCard();
    //    area.OnDrop += (o, e) =>
    //    {
    //        foreach (var item in e.Cards)
    //        {
    //            list.AddChild(item);
    //            this.cardState.Storage.Cards.Remove(item);
    //        }
    //        this.cardState.Canvas.JSRuntime.InvokeVoidAsync("alert", area.GetSize().X);
    //    };
    //    list.Fixed = true;
    //    var text = new BlazeCardsCore.Descriptors.TextCard();
    //    var pepis = new BlazeCardsCore.Descriptors.TextCard();
    //    pepis.Draggable = false;
    //    text.Clickable = false;

    //    //this.cardState.InteropQueue.QueueChange(new BlazeCardsCore.Models.PositionChange())

    //    list.AddChild(text);
    //    list.AddChild(pepis);
    //    list.AddChild(area);
    //    this.cardState.Storage.Cards.Add(list);
    //    this.cardState.Storage.Cards.Add(rect);
    //    //this.cardState.Storage.Init();
    //}
}